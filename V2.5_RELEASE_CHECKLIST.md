# YA-WAMF v2.5.1 Release Checklist

## âœ… Issues Fixed

### 1. Telemetry UUID Generation - **CRITICAL FIX APPLIED**
**File**: `backend/app/services/telemetry_service.py`

**What was wrong:**
- Synchronous `__init__` called async `settings.save()` without awaiting
- Could hang the entire application on first startup
- No timeout protection or retry logic

**What's fixed:**
- âœ… Moved ID generation to async `start()` method
- âœ… Added 5-second timeout per save attempt
- âœ… Added 20-second total timeout for initialization
- âœ… Implemented 3 retry attempts with exponential backoff (1s, 2s, 4s)
- âœ… Graceful fallback to in-memory ID if persistence fails
- âœ… Comprehensive error logging with context

**Testing Required:**
```bash
# 1. Fresh start (no existing config)
rm -rf config/ data/
docker-compose up -d
docker-compose logs yawamf-backend | grep "installation ID"

# Expected output:
# "Generated new anonymous installation ID id=abc12345..."
# "Installation ID persisted to config attempt=1"
# "Telemetry service started enabled=false has_persistent_id=true"

# 2. Verify config was created
cat config/config.json | jq '.telemetry.installation_id'
# Should show a UUID

# 3. Restart with existing ID
docker-compose restart yawamf-backend
docker-compose logs yawamf-backend | grep "Telemetry"
# Should NOT see "Generated new" (uses existing ID)
```

---

## ðŸ“ Documentation Updates Still Needed

### 1. `.env.example` - Version String
**File**: `YA-WAMF/.env.example`
**Line**: 36
```bash
# Change from:
APP_VERSION_BASE=2.3.1

# To:
APP_VERSION_BASE=2.5.1
```

### 2. `README.md` - Breaking Change Language
**File**: `YA-WAMF/README.md`
**Lines**: 3-4
```markdown
# Change from:
> **Upcoming Breaking Change (v2.5.0):** Container security is being improved...

# To:
> **v2.5.0 Breaking Change:** Container security has been improved...
```

---

## ðŸ§ª Testing Scenarios

### Scenario 1: Fresh Install (Most Important)
```bash
# Clean slate
rm -rf config/ data/
docker-compose down -v

# Start fresh
docker-compose up -d

# Verify:
# 1. Containers start without hanging
# 2. Telemetry ID is generated
# 3. Backend is healthy
curl http://localhost:8946/health
# Should return: {"status":"ok","service":"ya-wamf-backend","version":"2.5.1+..."}

# 4. Frontend loads
curl http://localhost:9852/
# Should return HTML
```

### Scenario 2: Migration from v2.4.x (Option 1 - Ownership Change)
```bash
# Simulate existing v2.4 installation
# (assumes config/ and data/ owned by root or different user)

# Apply Option 1 from MIGRATION.md
sudo chown -R 1000:1000 config data

# Pull and restart
docker-compose down
docker-compose pull
docker-compose up -d

# Verify:
# 1. No permission errors in logs
docker-compose logs yawamf-backend | grep -i "permission\|error"
# Should be clean

# 2. Existing data is preserved
# Check database
sqlite3 data/speciesid.db "SELECT COUNT(*) FROM detections;"
# Should show existing detection count
```

### Scenario 3: Migration from v2.4.x (Option 2 - PUID/PGID)
```bash
# Add to .env file
echo "PUID=568" >> .env
echo "PGID=568" >> .env

# Pull and restart
docker-compose down
docker-compose pull
docker-compose up -d

# Verify containers are running as UID 568
docker-compose exec yawamf-backend id
# Should show: uid=568 gid=568

# Verify file access works
docker-compose exec yawamf-backend ls -la /config /data
# Should succeed without errors
```

### Scenario 4: Read-Only Config (Resilience Test)
```bash
# Make config read-only
sudo chmod 444 config/config.json

# Restart backend
docker-compose restart yawamf-backend

# Verify:
# 1. Backend still starts (doesn't crash)
# 2. Logs show graceful degradation
docker-compose logs yawamf-backend | grep "installation ID"
# Should see: "Using in-memory installation ID (config save failed)"

# 3. Application is still functional
curl http://localhost:8946/health
# Should return: {"status":"ok",...}

# Restore permissions
sudo chmod 644 config/config.json
```

### Scenario 5: Slow Filesystem (NFS/Network Storage)
```bash
# If you're running on NFS or slow storage, verify:
# 1. Startup completes within 30 seconds
time docker-compose up -d
# Should complete in <30s

# 2. Check for retry attempts in logs
docker-compose logs yawamf-backend | grep "retry"
# May see some retries, but should eventually succeed

# 3. Verify timeout protection works
# Max startup delay should be 20 seconds for telemetry init
```

---

## ðŸ” Pre-Release Verification Checklist

Run through this checklist before committing to main:

- [ ] Apply documentation fixes (.env.example, README.md)
- [ ] Test Scenario 1: Fresh install works
- [ ] Test Scenario 2: Migration from v2.4 (Option 1)
- [ ] Test Scenario 3: Migration from v2.4 (Option 2)
- [ ] Test Scenario 4: Read-only config resilience
- [ ] Verify no hanging during startup
- [ ] Verify telemetry ID is persisted to config.json
- [ ] Verify backend health endpoint returns OK
- [ ] Verify frontend loads successfully
- [ ] Verify existing detections are preserved after migration
- [ ] Check Docker logs for any ERROR or CRITICAL messages
- [ ] Verify MIGRATION.md is accurate and complete
- [ ] Update CHANGELOG.md with v2.5.1 changes (if you have one)

---

## ðŸ“Š Expected Log Output (Success)

### Fresh Install
```
INFO     Generated new anonymous installation ID id=a1b2c3d4...
INFO     Installation ID persisted to config attempt=1
INFO     Telemetry service started enabled=false has_persistent_id=true
INFO     Connected to MQTT topic=frigate/events
INFO     Background cleanup scheduler started
```

### Existing Installation
```
INFO     Loaded config from file path=/config/config.json
INFO     Telemetry service started enabled=false has_persistent_id=true
INFO     Connected to MQTT topic=frigate/events
```

### Degraded (Read-only config)
```
WARNING  Failed to save installation ID to config error=...
WARNING  Config save timed out, will retry attempt=1 max_retries=3
WARNING  Using in-memory installation ID (config save failed)
INFO     Telemetry service started enabled=false has_persistent_id=true
```

---

## ðŸš€ Ready to Release?

After completing all tests above:

1. **Commit the fixes:**
```bash
git add backend/app/services/telemetry_service.py
git add .env.example README.md
git add agents/COMPREHENSIVE_CODE_REVIEW.md
git commit -m "fix: make telemetry UUID generation robust and non-blocking

- Move ID generation from __init__ to async start() method
- Add timeout protection (5s per attempt, 20s total)
- Implement retry logic with exponential backoff (3 attempts)
- Graceful degradation to in-memory ID if persistence fails
- Update documentation to reflect v2.5.1 release

Fixes potential event loop blocking and startup hangs on first run.
"
```

2. **Tag the release:**
```bash
git tag -a v2.5.1 -m "v2.5.1 - Container Security & Telemetry Robustness"
git push origin main --tags
```

3. **Monitor GitHub Actions:**
- Verify build-and-push workflow succeeds
- Check that images are pushed to ghcr.io with `latest` tag

4. **Announce the release:**
- Update GitHub Release notes
- Highlight the non-root container security improvement
- Link to MIGRATION.md for upgrade instructions

---

## ðŸ› Known Non-Blocking Issues (Post v2.5)

These can be addressed in v2.5.2 or v2.6:

- EventProcessor needs refactoring (331 lines)
- No database connection pooling
- Test coverage at ~5% (needs improvement)
- No retry logic for notification failures

**None of these block the v2.5.1 release.**

---

**Good luck with your testing! ðŸŽ‰**
