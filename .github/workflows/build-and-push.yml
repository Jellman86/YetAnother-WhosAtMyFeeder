name: Build and Push Docker Images

on:
  push:
    branches: [main, dev]
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run tests
        run: |
          cd backend
          python -m pytest tests/ -v --tb=short --cov=app --cov-report=term

      - name: Check minimum coverage
        run: |
          cd backend
          python -m pytest tests/ --cov=app --cov-fail-under=20

      - name: Ensure single Alembic head
        run: |
          cd backend
          python - <<'PY'
          import sys
          from alembic.config import Config
          from alembic.script import ScriptDirectory

          config = Config("alembic.ini")
          script = ScriptDirectory.from_config(config)
          heads = script.get_heads()
          if len(heads) != 1:
              print(f"Expected 1 Alembic head, found {len(heads)}: {heads}")
              sys.exit(1)
          print(f"Alembic head OK: {heads[0]}")
          PY

  build-backend:
    needs: test-backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set lowercase owner name
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        run: echo "APP_VERSION_BASE=$(cat VERSION)" >> $GITHUB_ENV

      - name: Get short SHA
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Determine image tag
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
          fi

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          build-args: |
            GIT_HASH=${{ env.SHORT_SHA }}
            APP_VERSION_BASE=${{ env.APP_VERSION_BASE }}
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/wamf-backend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/wamf-backend:${{ github.sha }}

  build-frontend:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set lowercase owner name
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        run: echo "APP_VERSION_BASE=$(cat VERSION)" >> $GITHUB_ENV

      - name: Get short SHA
        run: echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Determine image tag
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
          fi

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./apps/ui
          push: true
          build-args: |
            GIT_HASH=${{ env.SHORT_SHA }}
            APP_VERSION_BASE=${{ env.APP_VERSION_BASE }}
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/wamf-frontend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/wamf-frontend:${{ github.sha }}
