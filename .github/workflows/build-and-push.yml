name: Build and Push Docker Images

on:
  push:
    branches: [dev]
    tags: ["v*"]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Migration smoke test (fresh DB)
        run: |
          cd backend
          export DB_PATH=/tmp/ci-speciesid.db
          rm -f "$DB_PATH"
          python -m alembic upgrade head

      - name: Migration idempotency check
        run: |
          cd backend
          export DB_PATH=/tmp/ci-speciesid.db
          python -m alembic upgrade head

      - name: Migration downgrade/upgrade check
        run: |
          cd backend
          export DB_PATH=/tmp/ci-speciesid.db
          python -m alembic downgrade -1
          python -m alembic upgrade head

      - name: Run tests
        run: |
          cd backend
          python -m pytest tests/ -v --tb=short --cov=app --cov-report=term

      - name: Check minimum coverage
        run: |
          cd backend
          python -m pytest tests/ --cov=app --cov-fail-under=20

      - name: Ensure single Alembic head
        run: |
          cd backend
          python - <<'PY'
          import sys
          from alembic.config import Config
          from alembic.script import ScriptDirectory

          config = Config("alembic.ini")
          script = ScriptDirectory.from_config(config)
          heads = script.get_heads()
          if len(heads) != 1:
              print(f"Expected 1 Alembic head, found {len(heads)}: {heads}")
              sys.exit(1)
          print(f"Alembic head OK: {heads[0]}")
          PY

  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: apps/ui/package-lock.json

      - name: Install dependencies
        run: |
          cd apps/ui
          npm ci

      - name: Svelte check
        run: |
          cd apps/ui
          npm run check

      - name: Build frontend
        run: |
          cd apps/ui
          npm run build

  build-backend:
    needs: test-backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set lowercase owner name
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        run: echo "APP_VERSION_BASE=$(cat VERSION)" >> $GITHUB_ENV

      - name: Get branch and SHA
        run: |
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "APP_BRANCH=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Determine image tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "IMAGE_TAG=${GITHUB_REF_NAME}" >> $GITHUB_ENV
            echo "PUBLISH_LATEST=true" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
            echo "PUBLISH_LATEST=false" >> $GITHUB_ENV
          fi

      - name: Build and push backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          build-args: |
            GIT_HASH=${{ env.SHORT_SHA }}
            APP_VERSION_BASE=${{ env.APP_VERSION_BASE }}
            APP_BRANCH=${{ env.APP_BRANCH }}
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/wamf-backend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/wamf-backend:${{ github.sha }}
      - name: Tag backend latest
        if: env.PUBLISH_LATEST == 'true'
        run: |
          docker buildx imagetools create \
            -t ghcr.io/${{ env.OWNER_LC }}/wamf-backend:latest \
            ghcr.io/${{ env.OWNER_LC }}/wamf-backend:${{ env.IMAGE_TAG }}

  build-frontend:
    needs: test-frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set lowercase owner name
        run: echo "OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get version
        run: echo "APP_VERSION_BASE=$(cat VERSION)" >> $GITHUB_ENV

      - name: Get branch and SHA
        run: |
          echo "SHORT_SHA=${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "APP_BRANCH=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Determine image tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "IMAGE_TAG=${GITHUB_REF_NAME}" >> $GITHUB_ENV
            echo "PUBLISH_LATEST=true" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=dev" >> $GITHUB_ENV
            echo "PUBLISH_LATEST=false" >> $GITHUB_ENV
          fi

      - name: Build and push frontend
        uses: docker/build-push-action@v5
        with:
          context: ./apps/ui
          push: true
          build-args: |
            GIT_HASH=${{ env.SHORT_SHA }}
            APP_VERSION_BASE=${{ env.APP_VERSION_BASE }}
            APP_BRANCH=${{ env.APP_BRANCH }}
          tags: |
            ghcr.io/${{ env.OWNER_LC }}/wamf-frontend:${{ env.IMAGE_TAG }}
            ghcr.io/${{ env.OWNER_LC }}/wamf-frontend:${{ github.sha }}
      - name: Tag frontend latest
        if: env.PUBLISH_LATEST == 'true'
        run: |
          docker buildx imagetools create \
            -t ghcr.io/${{ env.OWNER_LC }}/wamf-frontend:latest \
            ghcr.io/${{ env.OWNER_LC }}/wamf-frontend:${{ env.IMAGE_TAG }}
